<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pension Dashboard</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link href="./css/style.css" rel="stylesheet" />
  </head>

  <body>
    <div id="toastArea" class="toast-area"></div>

    <div class="d-flex nav-shell">
      <!-- ‚úÖ Dynamic Navbar Mount -->
      <div id="bpNavbar" class="d-none d-lg-block"></div>

      <!-- Main -->
      <div class="flex-grow-1">
        <div class="topbar">
          <div
            class="container py-3 d-flex justify-content-between align-items-center"
          >
            <div>
              <div class="small text-secondary">Pensioner Panel</div>
              <div class="fw-bold">Dashboard</div>
              <div id="programText" class="small text-secondary mt-1">
                Program: ‚Äî
              </div>
            </div>

            <div class="d-flex gap-2">
              <button id="btnRefresh" class="btn btn-outline-soft">
                Refresh
              </button>
            </div>
          </div>
        </div>

        <div class="container py-4">
          <div class="hero-card p-4 p-md-5 mb-4">
            <div class="position-relative">
              <div class="d-flex flex-wrap gap-2 align-items-center">
                <div class="brand-pill">
                  <span class="dot" style="background: white"></span>
                  <span id="userBadgeText">Loading...</span>
                </div>

                <div
                  id="deceasedBadge"
                  class="brand-pill d-none"
                  style="background: #111827"
                >
                  <span class="dot" style="background: #fff"></span>
                  Deceased (Locked)
                </div>

                <!-- ‚úÖ Account Status Badge -->
                <div
                  id="accountStatusBadge"
                  class="brand-pill"
                  style="background: #111827"
                >
                  <span class="dot" style="background: #fff"></span>
                  <span id="accountStatusText" class="text-white"
                    >Account: ‚Äî</span
                  >
                </div>
              </div>

              <h2 class="fw-bold mt-3 mb-0">Blockchain Pension Portal</h2>
              <div class="text-white-50 mt-2 small">
                Start pension, choose mode, and withdraw pension.
              </div>
            </div>
          </div>

          <!-- ‚úÖ Account Closure Warning Box -->
          <div
            id="accountClosureNotice"
            class="soft-card p-4 mb-4 d-none"
            style="background: #fff7ed; border: 1px solid #fed7aa"
          >
            <div class="fw-bold">‚ö† Account Status Notice</div>
            <div
              id="accountClosureNoticeText"
              class="text-secondary small mt-1"
            >
              ‚Äî
            </div>
          </div>

          <!-- Summary -->
          <div class="row g-3">
            <div class="col-md-3">
              <div class="soft-card p-4">
                <div class="text-secondary small">Pension Started</div>
                <div id="pensionStarted" class="fw-bold fs-4 mt-1">‚Äî</div>
              </div>
            </div>

            <div class="col-md-3">
              <div class="soft-card p-4">
                <div class="text-secondary small">Pension Mode</div>
                <div id="pensionModeText" class="fw-bold fs-4 mt-1">‚Äî</div>
              </div>
            </div>

            <div class="col-md-3">
              <div class="soft-card p-4">
                <div class="text-secondary small">Monthly Amount</div>
                <div id="monthlyAmount" class="fw-bold fs-4 mt-1">‚Äî</div>
              </div>
            </div>

            <div class="col-md-3">
              <div class="soft-card p-4">
                <div id="totalContributionLabel" class="text-secondary small">
                  Total Contribution
                </div>
                <div id="totalContribution" class="fw-bold fs-4 mt-1">‚Äî</div>
              </div>
            </div>
          </div>

          <!-- Pensioner Info (DOB + Age) -->
          <div
            class="soft-card p-4 mt-4"
            style="background: #f8fafc; border: 1px solid #e2e8f0"
          >
            <div class="fw-bold">Pensioner Info</div>
            <div class="text-secondary small">
              Shows your DOB and age for pension eligibility (60+).
            </div>

            <div class="row g-3 mt-2">
              <div class="col-md-4">
                <div class="small text-secondary">Wallet</div>
                <div class="fw-bold" style="word-break: break-all">
                  <span id="walletText">Connected Wallet</span>
                </div>
              </div>

              <div class="col-md-4">
                <div class="small text-secondary">Date of Birth</div>
                <div id="dobText" class="fw-bold">‚Äî</div>
              </div>

              <div class="col-md-4">
                <div class="small text-secondary">Age</div>
                <div id="ageText" class="fw-bold">‚Äî</div>
              </div>
            </div>

            <div class="small text-secondary mt-3">
              ‚ö† If DOB is incorrect, you must re-register (DOB cannot be edited
              after registration).
            </div>
          </div>

          <!-- ‚úÖ Account Settings (Closure Request ONLY) -->
          <div
            class="soft-card p-4 mt-4"
            style="background: #f8fafc; border: 1px solid #e2e8f0"
          >
            <div class="fw-bold">Account Settings</div>
            <div class="text-secondary small">
              Request account closure if you want to permanently stop using this
              pension account.
            </div>

            <div class="row g-2 mt-3">
              <div class="col-md-6">
                <button
                  id="btnRequestClosure"
                  class="btn btn-outline-danger w-100"
                >
                  üóë Request Account Closure
                </button>
              </div>
            </div>

            <div class="small text-secondary mt-3">
              ‚ö† Closure request must be reviewed by Admin.
              <br />
              ‚ö† When closure is requested, your dashboard actions will be locked
              until admin decision.
            </div>
          </div>

          <!-- GPS Info -->
          <div
            id="gpsInfoBox"
            class="soft-card p-4 mt-4 d-none"
            style="background: #f8fafc; border: 1px solid #e2e8f0"
          >
            <div class="fw-bold">GPS Information</div>
            <div class="text-secondary small">
              These values are verified by admin.
            </div>

            <div class="row g-3 mt-2">
              <div class="col-md-3">
                <div class="small text-secondary">Basic Salary (BDT)</div>
                <div id="gpsSalary" class="fw-bold">‚Äî</div>
              </div>
              <div class="col-md-3">
                <div class="small text-secondary">Service Years</div>
                <div id="gpsServiceYears" class="fw-bold">‚Äî</div>
              </div>
              <div class="col-md-3">
                <div class="small text-secondary">Employee ID</div>
                <div id="gpsEmployeeId" class="fw-bold">‚Äî</div>
              </div>
              <div class="col-md-3">
                <div class="small text-secondary">Designation</div>
                <div id="gpsDesignation" class="fw-bold">‚Äî</div>
              </div>
            </div>
          </div>

          <!-- GPS Gratuity Box -->
          <div
            id="gpsGratuityBox"
            class="soft-card p-4 mt-4 d-none"
            style="background: #fff7ed; border: 1px solid #fed7aa"
          >
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold">GPS Gratuity (One-Time)</div>
                <div class="text-secondary small">
                  This is a lump sum payment for GPS pensioners based on
                  verified service years.
                </div>
              </div>

              <div class="brand-pill" style="background: #111827">
                <span class="dot" style="background: #fff"></span>
                <span id="gpsGratuityStatusText" class="text-white">‚Äî</span>
              </div>
            </div>

            <div class="row g-3 mt-3">
              <div class="col-md-4">
                <div class="soft-card p-3">
                  <div class="text-secondary small">Gratuity Amount</div>
                  <div id="gpsGratuityAmount" class="fw-bold fs-4 mt-1">‚Äî</div>
                  <div class="small text-secondary mt-1">
                    Based on: Basic Salary √ó Service Years (converted to ETH)
                  </div>
                </div>
              </div>

              <div class="col-md-8">
                <div class="soft-card p-3 h-100">
                  <div class="text-secondary small">Action</div>

                  <button
                    id="btnClaimGratuity"
                    class="btn btn-outline-danger w-100 mt-2"
                  >
                    üéÅ Claim GPS Gratuity (One-Time)
                  </button>

                  <div class="small text-secondary mt-3">
                    ‚ö† Gratuity is a one-time lump sum payment for GPS
                    pensioners.
                    <br />
                    ‚ö† You can still withdraw monthly pension after claiming
                    gratuity.
                    <br />
                    ‚ö† You cannot claim gratuity again after claiming once.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="soft-card p-4 mt-4">
            <div class="fw-bold">Actions</div>
            <div class="text-secondary small">
              Use these buttons based on your status.
            </div>

            <div class="row g-2 mt-3" id="prssPayRow">
              <div class="col-md-3" id="payCol">
                <button id="btnPay" class="btn btn-primary-soft w-100">
                  üí≥ Pay Monthly Contribution
                </button>
              </div>

              <div class="col-md-3">
                <button id="btnStart" class="btn btn-outline-soft w-100">
                  ‚ñ∂ Start Pension
                </button>
              </div>

              <div class="col-md-3">
                <button
                  id="btnChooseMonthly"
                  class="btn btn-outline-soft w-100"
                >
                  ‚úÖ Choose Monthly Mode
                </button>
              </div>

              <div class="col-md-3">
                <button id="btnWithdraw" class="btn btn-outline-soft w-100">
                  üí∏ Withdraw Monthly
                </button>
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-12">
                <button
                  id="btnWithdrawFull"
                  class="btn btn-outline-danger w-100"
                >
                  üí∞ Withdraw Full Amount (One Time)
                </button>
              </div>
            </div>

            <div class="small text-secondary mt-3">
              ‚ö† Pension start requires retirement age (60+) based on your DOB.
            </div>
            <div class="small text-secondary mt-1" id="schemeNote">
              ‚ö† Minimum monthly payments depends on scheme.
            </div>
            <div class="small text-secondary mt-1">
              ‚ö† Full withdrawal is one-time and permanently disables monthly
              pension.
            </div>
          </div>

          <!-- History -->
          <div class="soft-card p-4 mt-4">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold">History</div>
                <div class="text-secondary small">
                  These logs are read from blockchain events.
                </div>
              </div>

              <div class="d-flex gap-2">
                <button id="btnLoadHistory" class="btn btn-outline-soft">
                  Load History
                </button>
              </div>
            </div>

            <div class="row g-3 mt-3">
              <div class="col-md-4">
                <div class="p-3 rounded-4" style="background: #0b1220">
                  <div class="small text-white-50">Pension Started At</div>
                  <div id="pensionStartedAt" class="fw-bold text-white mt-1">
                    ‚Äî
                  </div>
                </div>
              </div>

              <div class="col-md-4">
                <div class="p-3 rounded-4" style="background: #0b1220">
                  <div class="small text-white-50">Monthly Payments Count</div>
                  <div
                    id="monthlyPaymentsCount"
                    class="fw-bold text-white mt-1"
                  >
                    ‚Äî
                  </div>
                  <div
                    id="monthlyPaymentsHint"
                    class="small text-white-50 mt-1"
                  >
                    ‚Äî
                  </div>
                </div>
              </div>

              <div class="col-md-4">
                <div class="p-3 rounded-4" style="background: #0b1220">
                  <div
                    id="totalContribHistoryLabel"
                    class="small text-white-50"
                  >
                    Total Contributions
                  </div>
                  <div id="totalContribHistory" class="fw-bold text-white mt-1">
                    ‚Äî
                  </div>
                </div>
              </div>
            </div>

            <hr class="my-4" />

            <div id="fundHistoryTitle" class="fw-bold">
              Contribution History
            </div>
            <div id="fundHistorySubtitle" class="text-secondary small">
              Shows your monthly payments with amount + time.
            </div>

            <div class="table-responsive mt-3">
              <table class="table table-sm align-middle">
                <thead>
                  <tr class="text-secondary small">
                    <th>#</th>
                    <th>Amount (ETH)</th>
                    <th>Time</th>
                    <th>Tx</th>
                  </tr>
                </thead>
                <tbody id="contributionHistoryBody">
                  <tr>
                    <td colspan="4" class="text-secondary small">
                      Click "Load History"
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <hr class="my-4" />

            <div class="fw-bold">Withdrawal History</div>
            <div class="text-secondary small">
              Shows pension withdrawals with amount + time.
            </div>

            <div class="table-responsive mt-3">
              <table class="table table-sm align-middle">
                <thead>
                  <tr class="text-secondary small">
                    <th>#</th>
                    <th>Amount (ETH)</th>
                    <th>Time</th>
                    <th>Tx</th>
                  </tr>
                </thead>
                <tbody id="withdrawHistoryBody">
                  <tr>
                    <td colspan="4" class="text-secondary small">
                      Click "Load History"
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="small text-secondary mt-3">
              ‚ö† On Hardhat local chain, logs reset after redeploy/restart.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>

    <!-- ‚úÖ Navbar Loader -->
    <script type="module">
      import { loadNavbar } from "./js/navbar.js";
      loadNavbar();
    </script>

    <script type="module" src="./js/app-dashboard.js"></script>

    <!-- ‚úÖ Small inline script to show wallet in UI -->
    <script type="module">
      try {
        const saved = localStorage.getItem("bp_account") || "";
        const el = document.getElementById("walletText");
        if (el) el.textContent = saved ? saved : "‚Äî";
      } catch (e) {
        console.warn("walletText set failed:", e);
      }
    </script>
  </body>
</html>
